<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <title></title>
            
            <script src="/jszip.min.js"></script>
            <script src="/epub.min.js"></script>
            
            <link rel="stylesheet" type="text/css" href="/epub-viewer.css">
    </head>
    <body>
        <select id="toc"></select>
        <div id="viewer" class="scrolled"></div>
        <div class="pager-container">
            <div id="pager-previous" class="pager">‹</div>
            <div id="pager-next" class="pager">›</div>
        </div>
        
        <script>
            (function () {
                var viewer = document.getElementById('viewer');
                var next = document.getElementById('pager-next');
                var prev = document.getElementById('pager-previous');
                var currentSection;
                var coverURL;
                
                const isFloat = v => Math.floor(v) !== Math.ceil(v);
                
                window.loadEPUB = function (url) {
                    //var url = "https://s3.amazonaws.com/moby-dick/moby-dick.epub"
                    // TODO: Synced UUID key here to auth requests for files
                    var book = ePub(url, {
                        requestHeaders: {
                            'IS_SWIFTUIWEBVIEW_VIEWER_FILE_REQUEST': 'true',
                        },
                        // allowScriptedContent: true,
                    })
                    
                    book.loaded.metadata.then(function (meta) {
                        document.title = meta.title
                        
                        function displayIfNeeded() {
                            book.loaded.navigation.then(function (toc) {
                                var hash = window.location.hash.slice(2)
                                if (!hash) {
                                    viewer.innerHTML = ""
                                    let coverImage = document.createElement('img')
                                    coverImage.src = coverURL
                                    viewer.appendChild(coverImage)
                                }
                            })
                        }
                        
                        function wireHash() {
                            var hash = window.location.hash.slice(2)
                            if (!hash) {
                                displayIfNeeded()
                            }
                            window.addEventListener('hashchange', () => {
                                if (!hash) {
                                    displayIfNeeded()
                                }
                            }, false)
                        }
                        
                        if (book.archive) {
                            book.archive.createUrl(book.cover)
                            .then(function (url) {
                                coverURL = url
                                window.webkit.messageHandlers.swiftUIWebViewImageUpdated.postMessage({url: window.location.href, imageURL: url})
                                wireHash()
                            })
                        } else {
                            coverURL = url
                            window.webkit.messageHandlers.swiftUIWebViewImageUpdated.postMessage({url: window.location.href, imageURL: url})
                            wireHash()
                        }
                        
                    })
                    
                    book.loaded.metadata.then(function (meta) {
                        book.loaded.navigation.then(function (navigation) {
                            book.loaded.spine.then(function (spine) {
                                //let toc = packaging.spine
                                //let toc = spine.items
                                var select = document.getElementById("toc"),
                                docfrag = document.createDocumentFragment()
                                
                                var hash = window.location.hash.slice(2)
                                if (hash) {
                                    display(hash)
                                } else {
                                    display(spine.items[0].href)
                                }
                                window.addEventListener('hashchange', () => {
                                    if (hash) {
                                        display(window.location.hash)
                                    }
                                }, false)
                                
                                /*
                                 // Cover page
                                 var option = document.createElement('option')
                                 option.textContent = meta.title
                                 option.value = ""
                                 docfrag.appendChild(option)
                                 */
                                
                                // Sections
                                spine.items.forEach(function (chapter) {
                                    var option = document.createElement('option')
                                    //option.textContent = chapter.label || chapter.id || chapter.href
                                    let tocChapter = getChapter(book, chapter)
                                    if (tocChapter) {
                                        option.textContent = tocChapter.label || chapter.href
                                    } else {
                                        option.textContent = chapter.href
                                    }
                                    option.id = 'swiftuiwebview-epubjs-' + chapter.id
                                    option.value = chapter.href
                                    docfrag.appendChild(option)
                                })
                                select.appendChild(docfrag)
                                select.onchange = function () {
                                    var index = select.selectedIndex,
                                    hash = select.options[index].value
                                    display(hash)
                                    return false
                                }
                                
                                /*book.opened.then(function () {
                                 display(currentSectionIndex);
                                 })*/
                                
                                next.addEventListener('click', function () {
                                    display(currentSection.index + 1);
                                }, false)
                                
                                prev.addEventListener('click', function () {
                                    display(currentSection.index - 1);
                                }, false)
                                
                                function display(target) {
                                    // Check if this is a book percentage
                                    /*if (book.locations.length() && isFloat(target)) {
                                     target = book.locations.cfiFromPercentage(parseFloat(target))
                                     }*/
                                    
                                    /*toc.forEach(function (section) {
                                     if (section.id === target && section.textContent) {
                                     viewer.innerHTML = ""
                                     window.location.hash = "#" + section.id
                                     viewer.innerHTML = section.textContent
                                     return
                                     }
                                     })*/
                                    
                                    var section = book.spine.get(target)
                                    if (section) {
                                        currentSection = section
                                        section.render(book.request).then(function (html) {
                                            viewer.innerHTML = ''
                                            window.location.hash = '#' + section.href
                                            viewer.innerHTML = html
                                            
                                            window.scrollTo({ top: 0, behavior: 'instant' })
                                            
                                            refreshNavigation(section)
                                        });
                                    }
                                    return
                                }
                                
                                function refreshNavigation(section) {
                                    select.value = section.href
                                    console.log(section)
                                    return
                                    
                                    let renderer = book.renderer
                                    let spinePos = renderer.currentChapter.spinePos
                                    let spineLength = book.spine.length
                                    let chapterPos = renderer.chapterPos
                                    let chapterLength = renderer.currentChapter.pages
                                    
                                    if ((spinePos === 0) && (chapterPos === 1)) {
                                        // On first page - you can hide the previous page button.
                                        document.getElementById('pager-previous').style.display = 'none'
                                    } else {
                                        document.getElementById('pager-previous').style.display = 'inline'
                                    }
                                    
                                    if ((spinePos === spineLength - 1) && (chapterPos === chapterLength)) {
                                        // On last page - you can hide the next page button.
                                        document.getElementById('pager-next').style.display = 'none'
                                    } else {
                                        document.getElementById('pager-next').style.display = 'inline'
                                    }
                                }
                                
                                function flatten(chapters) {
                                    return [].concat.apply([], chapters.map((chapter) => [].concat.apply([chapter], flatten(chapter.subitems))))
                                }
                                
                                function getCfiFromHref(href) {
                                    const [_, id] = href.split('#')
                                    const section = book.spine.get(href)
                                    const el = (id ? section.document.getElementById(id) : section.document.body)
                                    return section.cfiFromElement(el)
                                }
                                
                                function getChapter(section) {
                                    //let sectionCFI = section.cfiFromElement(section.document.body)
                                    let sectionCFI = getCfiFromHref(section.href)
                                    //const locationHref = location.start.href
                                    
                                    let match = flatten(book.navigation.toc)
                                    .filter((chapter) => {
                                        return book.canonical(chapter.href).includes(book.canonical(section.href))
                                    }, null)
                                    .reduce((result, chapter) => {
                                        const locationAfterChapter = EpubCFI.prototype.compare(sectionCFI, getCfiFromHref(book, chapter.href)) > 0
                                        return locationAfterChapter ? chapter : result
                                    }, null);
                                    
                                    return match;
                                }
                            });
                        });
                    });
                    
                }
                
                window.webkit.messageHandlers.swiftUIWebViewEPUBJSInitialized.postMessage({})
            })()
        </script>
    </body>
</html>
