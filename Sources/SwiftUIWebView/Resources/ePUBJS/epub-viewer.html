<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <title></title>
            
            <script src="/jszip.min.js"></script>
            <script src="/epub.min.js"></script>
            
            <link rel="stylesheet" type="text/css" href="/epub-viewer.css">
    </head>
    <body>
        <select id="toc"></select>
        <div id="viewer" class="scrolled"></div>
        <div id="prev" class="arrow">‹</div>
        <div id="next" class="arrow">›</div>
        
        <script>
            (function () {
                var viewer = document.getElementById("viewer");
                var next = document.getElementById("next");
                var prev = document.getElementById("prev");
                var currentSection;
                var coverURL;
                
                const isFloat = v => Math.floor(v) !== Math.ceil(v);
                
                window.loadEPUB = function (url) {
                    //var url = "https://s3.amazonaws.com/moby-dick/moby-dick.epub"
                    var book = ePub(url, {
                        /*openAs: "epub",
                        allowScriptedContent: true,*/
                    })
                    
                    book.loaded.metadata.then(function (meta) {
                        document.title = meta.title
                        
                        function displayIfNeeded() {
                            book.loaded.navigation.then(function (toc) {
                                var hash = window.location.hash.slice(2)
                                if (!hash) {
                                    viewer.innerHTML = ""
                                    let coverImage = document.createElement('img')
                                    coverImage.src = coverURL
                                    viewer.appendChild(coverImage)
                                }
                            })
                        }
                        
                        function wireHash() {
                            var hash = window.location.hash.slice(2)
                            if (!hash) {
                                displayIfNeeded()
                            }
                            window.addEventListener('hashchange', () => {
                                if (!hash) {
                                    displayIfNeeded()
                                }
                            }, false)
                        }
                        
                        if (book.archive) {
                            book.archive.createUrl(book.cover)
                            .then(function (url) {
                                coverURL = url
                                window.webkit.messageHandlers.swiftUIWebViewImageUpdated.postMessage({url: window.location.href, imageURL: url})
                                wireHash()
                            })
                        } else {
                            coverURL = url
                            window.webkit.messageHandlers.swiftUIWebViewImageUpdated.postMessage({url: window.location.href, imageURL: url})
                            wireHash()
                        }
                        
                    })
                    
                    book.loaded.navigation.then(function (toc) {
                        var select = document.getElementById("toc"),
                        docfrag = document.createDocumentFragment()
                        
                        var hash = window.location.hash.slice(2)
                        if (hash) {
                            display(hash)
                        }
                        window.addEventListener('hashchange', () => {
                            if (hash) {
                                display(window.location.hash)
                            }
                        }, false)
                        
                        toc.forEach(function (chapter) {
                            var option = document.createElement('option')
                            option.textContent = chapter.label
                            option.ref = chapter.href
                            docfrag.appendChild(option)
                        })
                        
                        select.appendChild(docfrag)
                        
                        select.onchange = function () {
                            var index = select.selectedIndex,
                                hash = select.options[index].ref
                            display(hash)
                            return false
                        }
                        
                        /*book.opened.then(function () {
                         display(currentSectionIndex);
                         })*/
                        
                        /*next.addEventListener("click", function () {
                         var displayed = display(currentSectionIndex+1);
                         if(displayed) currentSectionIndex++;
                         }, false);
                         
                         prev.addEventListener("click", function () {
                         var displayed = display(currentSectionIndex-1);
                         if(displayed) currentSectionIndex--;
                         }, false);*/
                        
                        function display(target) {
                            // Check if this is a book percentage
                            if (book.locations.length() && isFloat(target)) {
                                target = book.locations.cfiFromPercentage(parseFloat(target))
                            }
                            
                            var section = book.spine.get(target)
                            if (section) {
                                currentSection = section
                                section.render(book.request).then(function (html) {
                                    viewer.innerHTML = ""
                                    window.location.hash = "#" + section.href
                                    viewer.innerHTML = html
                                })
                            }
                            return section;
                        }
                    });
                }
                
                window.webkit.messageHandlers.swiftUIWebViewEPUBJSInitialized.postMessage({})
            })()
        </script>
    </body>
</html>
